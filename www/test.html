<h1>OAuth2 Fetch test with mock service worker</h1>
<button data-simply-command="fetch" data-simply-value="https://resource-server.mock/protected/">Fetch protected resource</button>
<button data-simply-command="fetch" data-simply-value="https://resource-server.mock/public/">Fetch public resource</button>

<script src="https://unpkg.com/msw@0.39.2/lib/iife/index.js"></script>
<script src="https://unpkg.com/simplyview@2.0.2/js/simply.command.js"></script>
<script>
	let loaded = false;
	let swURL  = document.location.pathname.replace(/\/[^/]*\/?$/, '') + '/mockServiceWorker.js'

	async function startMSW() {
		if (!loaded) {
			let {default:handlers} = await import('../src/mocks/handlers.js')
			const worker = window.MockServiceWorker.setupWorker(...handlers)
			return worker.start({
				serviceWorker: {
					url: swURL
				}
			})
		} else {
			return new Promise((resolve, reject) => {
				resolve()
			})
		}
	}
	window.startMSW = startMSW
</script>
<script>
	startMSW()
	.then(async () => {
		let {default:oauth2fetch} = await import('../src/Fetch/OAuth2Fetch.js')
		
		const commands = simply.command({
			container: document.body
		}, {
			fetch: (el, value) => {
				let req = new Request(value)
				console.log(req)
				oauth2fetch(req)
				.then((response) => {
					console.log(response)
				})
				.catch((err) => {
					console.error(err)
				})
			}
		})

	})
</script>