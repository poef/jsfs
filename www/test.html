<h1>OAuth2 Fetch test with mock service worker</h1>
<button data-simply-command="fetch" data-simply-value="https://resource-server.mock/protected/">Fetch protected resource</button>
<button data-simply-command="fetch" data-simply-value="https://resource-server.mock/public/">Fetch public resource</button>

<script src="https://unpkg.com/msw@0.39.2/lib/iife/index.js"></script>
<script src="https://unpkg.com/simplyview@2.0.2/js/simply.command.js"></script>
<script type="module">
	let loaded = false;
	async function startMSW() {
		if (!window.MockServiceWorker) {
			return new Promise((resolve, reject) => {
				window.setTimeout(() => {
					startMSW().then(resolve())
				}, 500)
			})
		}
		if (!loaded) {
			let handlers = await import('../src/mocks/handlers.js')
			handlers = handlers.handlers
			const worker = window.MockServiceWorker.setupWorker(...handlers)
			return worker.start({
				serviceWorker: {
					url: './mockServiceWorker.js'
				}
			})
		} else {
			return new Promise((resolve, reject) => {
				resolve()
			})
		}
	}
	window.startMSW = startMSW
</script>
<script type="module">
	import OAuth2Fetch from '../src/Fetch/OAuth2Fetch.js'

	startMSW()
	.then(() => {

		const commands = simply.command({
			container: document.body
		}, {
			fetch: (el, value) => {
				let req = new Request(value)
				console.log(req)
				OAuth2Fetch(req)
				.then((response) => {
					console.log(response)
				})
				.catch((err) => {
					console.error(err)
				})
			}
		})

	})
</script>